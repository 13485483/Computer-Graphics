<!-- 
    SolarSystemThreeJS/textures.html
    Auteur/Author : Frédéric CANAUD
-->

<!DOCTYPE html>
<html>

<head>
    <title>TP2 - WebGL</title>
    <meta charset="UTF-8">
    <meta name="viewport">
</head>

<body>
    <div id="container"></div>
    <script src="js/dat.gui.min.js" type="text/javascript"></script>
    <script src="js/three.js" type="text/javascript"></script>
    <script src="js/OrbitControls.js" type="text/javascript"></script>
    <script src="functions.js" type="text/javascript"></script>
    <script type="text/javascript">
        var pointLight, plan;

        var sun, mercury, venus, moon, earth, mars, jupiter, saturn, uranus, neptune, ring;
        var controls, scene, camera, renderer, scene;

        // Déclaration des planètes et des anneaux
       
        var mercuryData = defineTexturedPlanet(87.97, 0.015, 10, 0.38, "./img/mercury.jpg");
        var venusData = defineTexturedPlanet(224.70, 0.015, 19, 0.95, "./img/venus.jpg");
        var earthData = defineTexturedPlanet(365.2564, 0.015, 25, 1, "./img/earth.jpg");
        var moonData = defineTexturedPlanet(29.5, 0.01, 2.8, 0.5, "./img/moon.jpg");
        var marsData = defineTexturedPlanet(686.98, 0.015, 38, 0.53, "./img/mars.jpg");
        var jupiterData = defineTexturedPlanet(825.59, 0.007, 53, 11, "./img/jupiter.jpg");
        var saturnData = defineTexturedPlanet(1075.23, 0.004, 78, 8, "img/saturn.jpg");
        var uranusData = defineTexturedPlanet(1485.40, 0.002, 100, 2, "img/uranus.jpg");
        var neptuneData = defineTexturedPlanet(1866.00, 0.0005, 120, 2, "img/neptune.jpg");




        // var geometry = new Saturn.geometryRing(innerRadius, outerRadius, 60);
        // var texture = new THREE.TextureLoader().load("./images/SatRing.png");
        // var material = new THREE.MeshLambertMaterial({ color: 0xffffff });
        // var ringsMesh = new THREE.Mesh( geometry, material );
        // ringsMesh.position.copy(position);
        // ringsMesh.doubleSided = true;
        // return ringsMesh;

        
        var saturnRingData = defineRing(9.3, 8.3, 0x757064, saturnData.distanceFromOrbitCenter);
        var saturnRing2Data = defineRing(10.3, 9.6, 0x757064, saturnData.distanceFromOrbitCenter);
        var uranusRingData = defineRing(3.6, 3.3, 0x4fbfff, uranusData.distanceFromOrbitCenter);

        var orbitData = { value: 10, runOrbit: true, runRotation: true };
        var clock = new THREE.Clock();

        function init() {

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('container').appendChild(renderer.domElement);

            ////////////////////////////////////// CAMERA ////////////////////////////////////

            camera = new THREE.PerspectiveCamera(
                100,
                window.innerWidth / window.innerHeight,
                1,
                1000
            );
            camera.position.z = 30;
            camera.position.x = -30;
            camera.position.y = 30;

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            scene = new THREE.Scene();

            /////////////////////////////////// LUMIERE - LIGHT ////////////////////////////////

            pointLight = new THREE.PointLight(0xffdcb4, 3);
            scene.add(pointLight);
            var ambientLight = new THREE.AmbientLight(0xaaaaaa);
            scene.add(ambientLight);

            //////////////////////////////////////// PLAN //////////////////////////////////////
            
            var planGeometry = new THREE.PlaneGeometry(75, 75, 0);
            var whiteMaterial = new THREE.MeshBasicMaterial({ color: 0x615e5e, side: THREE.DoubleSide, transparent: true,  opacity: 0.35 });
            plan = new THREE.Mesh(planGeometry, whiteMaterial);
            plan.rotation.x = Math.PI / 2;
            plan.position.y -= 25;
            scene.add(plan);
            
            /////////////// SOLEIL, PLANETES ET ANNEAUX - SUN, PLANETS AND RING /////////////////

             sunTexture = new THREE.TextureLoader().load('img/sun.jpg');
            var sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            var sunGeometry = new THREE.SphereGeometry(8, 24, 24);
            sun = new THREE.Mesh(sunGeometry, sunMaterial);

            // Ajout d'un "glow effect" sur le soleil à l'aide d'un Sprite
            var spriteMaterial = new THREE.SpriteMaterial({map: new THREE.TextureLoader().load("img/glow.png"), color: 0xffff88, transparent: false, blending: THREE.AdditiveBlending});
            var sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(30, 30, 1.0); // Permet d'agrandir la taille du glow effect
            sun.add(sprite); 
            scene.add(sun);

            // Create a  background
            // const etoileTexture = new THREE.TextureLoader().load('img/star.jpg');
            // var etoileMaterial = new THREE.MeshBasicMaterial({ map: etoileTexture, side: THREE.DoubleSide });
            // var etoileGeometry = new THREE.SphereGeometry(320, 160);
            // etoile = new THREE.Mesh(etoileGeometry, etoileMaterial);
            // scene.add(etoile);

             /*var starsGeometry = new THREE.SphereGeometry(90, 32, 32);
             var starsMaterial = new THREE.MeshBasicMaterial({
             map: THREE.ImageUtils.loadTexture('img/galaxy_starfield.png'),
             side: THREE.BackSide
            });
             var stars = new THREE.Mesh(starsGeometry, starsMaterial);
             scene.add(stars);*/

           /* starGeo = new THREE.Geometry();
            var starCount= {amount: 0};
            for(let i=0; i<8000; i++){
            star = new THREE.Vector3(
                Math.random() * 600 - 300,
                Math.random() * 600 - 300,
                Math.random() * 600 - 300
             );
        starGeo.vertices.push(star);
            }
            let sprite1 = new THREE.TextureLoader().load('img/star.png');
            let starMaterial = new THREE.PointsMaterial({
                color: 0xaaaaaa,
            size: 0.5,
            map: sprite1
        })
        stars = new THREE.Points(starGeo,starMaterial);
        scene.add(stars);*/
        this.addStars = function(starsCount, minDistance){
        var d = function(){return (Math.random()-0.5)*2 * minDistance;}; 

        var geometry = new THREE.Geometry();
        for(var i = 0; i < starsCount; i++){
            var star = new THREE.Vector3(d(),d(),d());
            if(star.length() < minDistance) {
                star.setLength(minDistance);
            }
            geometry.vertices.push(star);
        }
        
        var r = Math.random();
        var size = 0.5;
        if(r  < 0.5) size =1;
        else if(r < 0.8) size = 1.5;
        else size =2;
        var material = new THREE.PointsMaterial({color:0xf0f0f0, size:size, sizeAttenuation: false});
        material.shininess = 1000;
        var stars = new THREE.Points(geometry, material);
        this.scene.add(stars);
    };

var starCount = {starNumber: 1};




            
            camera.lookAt(new THREE.Vector3(sun.position.x, sun.position.y, sun.position.z));

            mercury = createTexturedPlanet(mercuryData);
            venus = createTexturedPlanet(venusData);
            earth = createTexturedPlanet(earthData);
            moon = createTexturedPlanet(moonData);
            mars = createTexturedPlanet(marsData);
            jupiter = createTexturedPlanet(jupiterData);
            saturn = createTexturedPlanet(saturnData);
            uranus = createTexturedPlanet(uranusData);
            neptune = createTexturedPlanet(neptuneData);

            saturnRing = createRing(saturnRingData);
            saturnRing2 = createRing(saturnRing2Data);
            uranusRing = createRing(uranusRingData);

            traceOrbits();

            ///////////////////////////////////////// GUI /////////////////////////////////////////

        
            var gui;
            var atSun = new Boolean(false);
            var atEarth = new Boolean(false);
            var refresh = new Boolean(false);
    function buildGui()
    {
      gui = new dat.GUI();
      var orbitFolder = gui.addFolder('speed');
      var lightFolder = gui.addFolder('light');
      var starFolder = gui.addFolder('star');
      var camFolder  = gui.addFolder('camera');
      var params = {
        value: orbitData.value,
        runOrbit: orbitData.runOrbit,
        addStars: starCount.starNumber,
        sun: atSun = Boolean(false),
        earth: atEarth = Boolean(false),
        refresh: refresh = Boolean(false)
      }
      orbitFolder.add(params, 'value', 1, 10).onChange(function (val)
      {
        orbitData.value = val;
      });
      orbitFolder.add(params, 'runOrbit', 0, 1).onChange(function (val)
      {
        orbitData.runOrbit = val;
      });
      lightFolder.add(pointLight, 'intensity', 0, 10);
      starFolder.add(params, 'addStars', 1, 10000).onChange(function (val)
      {
        starCount.starNumber = val;
        addStars(starCount.starNumber, 1000);
      });
      camFolder.add(params, 'sun', 0, 1).onChange(function (val)
      {
          atSun = val; 
          camera.position.x = sun.position.x;
          camera.position.y = sun.position.y;
          camera.position.z = sun.position.z;
        
      }
      );
      
      camFolder.add(params, 'earth', 0, 1).onChange(function (val)
      {
          atEarth = true; 
          camera.position.x = sun.position.x + 25;
          camera.position.y = sun.position.y;
          camera.position.z = sun.position.z;
      }
      );
      camFolder.add(params, 'refresh', 0, 1).onChange(function (val)
      {
          refresh = true; 
          camera.position.z = 30;
        camera.position.x = -30;
        camera.position.y = 30;
      }
      );
     
      gui.open();
    }
    buildGui();
        }
        function animate() {

            var time = Date.now();

            // Mouvement du soleil, des planètes/lunes et des anneaux
            // Moving sun, planets/moons and rings
            sun.rotation.y += orbitData.value * 10;
            movePlanet(earth, earthData, time);
            movePlanet(mercury, mercuryData, time);
            movePlanet(venus, venusData, time);
            movePlanet(earth, earthData, time);
            movePlanet(mars, marsData, time);
            movePlanet(jupiter, jupiterData, time);
            movePlanet(saturn, saturnData, time);
            movePlanet(uranus, uranusData, time);
            movePlanet(neptune, neptuneData, time);

            moveMoon(moon, earth, moonData, time);
            movePlanet(saturnRing, saturnData, time, true);
            movePlanet(saturnRing2, saturnData, time, true);
            movePlanet(uranusRing, uranusData, time, true);

            // Au cas où le Soleil devait se déplacer - In case Sun has to move
            pointLight.position.copy(sun.position);
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
            
        };

        
        init();
        animate();

    </script>
</body>

</html>